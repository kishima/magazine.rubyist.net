---
layout: post
title: mruby/cで始めるオリジナルIoTデバイス作り
short_title: mruby/cで始めるオリジナルIoTデバイス作り
tags: 0059 mrubyc_iot
post_author: kishima
created_on: 2019-01-27
---
{% include base.html %}

## はじめに

こんにちは、kishimaと申します。
mruby/cという言語のことを皆さんは御存知でしょうか？
この記事では、mruby/cを使ったIoTっぽい工作入門について説明していきたいと思います。

###　mruby/cでIoT

筆者は仕事で馴染み深いのもあり、2017年後半あたりから電子工作を本格的に趣味で始めました。
制御にはマイコンにソフトを書き込むわけですが、言語は基本的にC言語を用いてきました。

しかしちょっとした機能の実装にいつもC言語使うのも面倒と感じる場面も多く、Rubyのようなスクリプト言語を使えたらいいなとずっと思ってきました。

最近では、mrubyという選択肢もあるわけなのですが、RAMが数百KB程度のマイコンで動かすことを考えると、mrubyは動かせないということはないですが、ある程度自由に実装するにはちょっとリソースがぎりぎりであることが多く、見送ってきました。

それでちょっと調べてみると、よりマイコン向けに特化した「mruby/c」というものが開発されていることを見つけ、これだ！と思い、早速飛びついたわけです。

## mruby/cとは

mruby/cとは、しまねソフト研究開発センターの[サイトの記載](https://www.s-itoc.jp/activity/research/mrubyc/)によれば、

> 「mruby/cは、Rubyの特徴を引き継ぎつつ、プログラム実行時に必要なメモリ消費量が従来のmruby（福岡で開発された組込み向けの軽量Ruby）より少ないmrubyの実装です。」

というものだそうです。



###　特徴

http://www.s-itoc.jp/activity/research/mrubyc/
https://github.com/mrubyc/mrubyc

言語としての機能がかなり制限されていますが、その分とてもコンパクトです。
デフォルト設定の実行環境としての規模は↓程度です。

ROM：100K+バイトコード分
RAM：5KB＋ヒープ用
vm_config.h の定数を書き換えると最大オブジェクト数などの上限を増やすことができます。
使用するメモリの上限をコントロール可能なのはよいと思います。

規模が小さいので、各処理の動きの見当が付きやすく、ポーティングが非常にやりやすいと感じました。

###　mrubyとの違い

## 開発環境の構築

PCアプリの開発と違って、ハードウェアの準備から始まるのが特徴です。
特にデバイス単体で通信を行うようなデバイスで、国内で個人で手に入るものはあまり選択肢が多くありません。
（海外で売られているデバイスは日本の周波数帯と合わないか、もしくは日本での認可を得ていないことが多いので注意です）

今回はWioLTEというLTEでデータ通信可能なボードを利用したいと思います。

またボード単体では基地局と通信できないので、日本のモバイル通信網に接続可能なSIMカードも必要です。

今回は簡単に手に入って、初期費用も安いSORACOM Air SIMを利用します。

###　WioLTEの説明

Wio LTEは中国深センのSeeed Studio社製のLTE通信ボードです。
制御マイコンがSTM32というARMのマイコンで回路図も公開されていてハックしやすいです。
ちゃんと日本用のバージョンが販売されており、安心して使えます。

**！注意！**
2019年1月現在Wio LTEは各種通販サイトで在庫切れとなっています。
Wio 3Gという3G版のボードもあるので、そちらの利用をご検討ください。
筆者の環境では未確認ですが、本記事の内容はほぼそのまま適用できるかと思います。

インタフェースとして同社製品用のGroveコネクタ搭載。

WioLTEのスペックは以下の通りとなっています。



WioLTEは日本向けにArduinoのライブラリが公開されていて、説明も手厚いです。
https://github.com/SeeedJP/WioLTEforArduino/wiki/Home-ja

個人で遊ぶにはちょうど良さそうなので、これを採用。SIMはソラコムのものを利用することにしました。

開発環境としては、ArduinoIDEを使うのが最もお手軽かと思います。
下記の資料がわかりやすいです。
https://github.com/soracom/handson/wiki/Wio-LTE-%E3%83%8F%E3%83%B3%E3%82%BA%E3%82%AA%E3%83%B3

###　SORACOM Air SIM for セルラーの説明

SORACOM Air SIM for セルラーは、SORACOMが販売しているデータ通信用SIMカードで、IoTのような少量のデータ通信を行うようなユースケースに適したSIMカードです。これを用いることで、SORACOMが提供するデータ管理サービスとの連携も可能になります。

詳しくは以下を参照下さい。
https://soracom.jp/services/air/

基本的にはAmazonなどで購入して、公式サイトの手順に従ってWeb画面上で開通処理を行うだけですぐ使えるようになります。
通信量も安いので、個人でちょっと試したい場合にも気軽に使えると思います。

## 実装方法

ではどうやってmruby/cをWioLTEの上で動かすのか、その手順について説明していきます。

###　mruby/cのポーテイング

Arduino環境にmruby/cを移植するのは以下のようなステップを踏みます。

* mruby/cのリポジトリの取得
  https:// から取得します。
* Arduinoのライブラリとして登録
* コンパイルエラーの除去

実際にポーティングした結果のソースコードを下記のリポジトリにアップしています。

###　C拡張の書き方

mruby/cをポーティングしただけの状態だと、シリアルのコンソールに文字が出力されるだけで、他に何もすることができません。


###　LTEでWebサーバにデータを送るAPIの作成

## 動かし方

###　WioLTE実機への転送

###　動作チェック

では実際に動かしてみましょう。
動かしてみた結果のログを示します。


実際に測定した距離の数値が転送されていることが確認できました！

この先は、Soracom Beamのような機能を利用して、AWSとの連携も可能です。後は煮るなり焼くなり自由自在というわけです。

## まとめ

この記事では、WioLTEというモバイルデータ通信が可能なボード上で、mruby/cを使って開発を行う基本的な方法を紹介しました。
環境をそろえるのが面倒だったりしますが、一度始めてしまえば意外とあっさり動くので、興味のある方はぜひトライしてみてほしいです。

## 著者について

[@kishima](https://twitter.com/kishima)

組み込みソフト系サラリーマンです。Rubyは趣味で触れ合うことが多いです。
TokyuRuby会議のスタッフをしたり、Kawasaki.rbに時々参加したりしています。
